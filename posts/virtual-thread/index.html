<!DOCTYPE html><html lang="ko" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="[Java] Virtual Thread" /><meta name="author" content="jeonyoungho" /><meta property="og:locale" content="ko" /><meta name="description" content="우아한 테크 세미나 ‘Java의 미래, Virtual Thread’ 학습 내용을 정리하기 위한 포스팅입니다😀" /><meta property="og:description" content="우아한 테크 세미나 ‘Java의 미래, Virtual Thread’ 학습 내용을 정리하기 위한 포스팅입니다😀" /><link rel="canonical" href="https://jeonyoungho.github.io/posts/virtual-thread/" /><meta property="og:url" content="https://jeonyoungho.github.io/posts/virtual-thread/" /><meta property="og:site_name" content="Youngho’s Devlog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-02-08T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[Java] Virtual Thread" /><meta name="twitter:site" content="@jeonyoungho_o" /><meta name="twitter:creator" content="@jeonyoungho" /><meta name="google-site-verification" content="eonGeSiIVfF48EnFoJqakC7h2hUzgqxFNJaxkfPiGr0" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"jeonyoungho"},"dateModified":"2025-05-01T23:22:59+09:00","datePublished":"2025-02-08T00:00:00+09:00","description":"우아한 테크 세미나 ‘Java의 미래, Virtual Thread’ 학습 내용을 정리하기 위한 포스팅입니다😀","headline":"[Java] Virtual Thread","mainEntityOfPage":{"@type":"WebPage","@id":"https://jeonyoungho.github.io/posts/virtual-thread/"},"url":"https://jeonyoungho.github.io/posts/virtual-thread/"}</script><title>[Java] Virtual Thread | Youngho's Devlog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Youngho's Devlog"><meta name="application-name" content="Youngho's Devlog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-RF6ZGDWXV1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-RF6ZGDWXV1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5958719204143086" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/youngho_employee_pic.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Youngho's Devlog</a></div><div class="site-subtitle font-italic">curios developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/jeonyoungho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/jeonyoungho_o" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['yhjun1000','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>[Java] Virtual Thread</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"> <ins class="adsbygoogle" style="display:block; margin-top: 30px;" data-ad-client="ca-pub-5958719204143086" data-ad-slot="1982371670" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[Java] Virtual Thread</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> jeonyoungho </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 8, 2025, 12:00 AM +0900" prep="on" > Feb 8 <i class="unloaded">2025-02-08T00:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, May 1, 2025, 11:22 PM +0900" prefix="Updated " > May 1 <i class="unloaded">2025-05-01T23:22:59+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2943 words">16 min</span></div></div><div class="post-content"><blockquote><p><a href="https://www.youtube.com/watch?v=BZMZIM-n4C0">우아한 테크 세미나 ‘Java의 미래, Virtual Thread’</a> 학습 내용을 정리하기 위한 포스팅입니다😀</p></blockquote><h1 id="1-일반-thread-모델">1. 일반 Thread 모델</h1><p>일반 스레드 모델은 다음과 같은 특징을 가진다.</p><ul><li>플랫폼 스레드<li>OS에 의해 스케줄링<li>커널 스레드와 1대1 매핑<li>작업 단위 Runnable</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/a94d62e2-5963-48e8-b52c-3bcbf0497e85" alt="Image" /></p><p>애플리케이션은 커널 영역(OS), 유저 영역(JVM) 두 가지 영역을 통해 실행된다.</p><p>커널 스레드와 플랫폼 스레드는 1대1로 매핑되며 이 두 사이를 통신하는 과정(유저 영역에서 커널 영역의 기능을 사용)은 JNI(Java Native Interface)를 통한 시스템콜(system call)을 통해 이뤄진다.</p><p>내부적인 실행 메커니즘은 다음과 같다.</p><p><strong>1. 유저 영역(JVM)에 플랫폼 스레드 객체가 생성된다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/157143b7-c4a5-4357-a6af-64edb2f79553" alt="Image" /></p><p><strong>2. 스레드 실행(Thread.start 메서드)시 JNI를 통해 커널 영역에 커널 스레드 생성을 요청한다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/3ec86494-5093-4e01-b7dc-1d07a4e47a7e" alt="Image" /></p><p><strong>3. 생성된 커널 스레드는 OS의 스케줄러에 의해 스케줄링되는 방식으로 실행된다.</strong></p><p>이를 실제 자바 코드로 살펴보면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/48260f0f-73c6-451f-b6a0-0befb346790a" alt="Image" /></p><p>Thread.start 메서드를 호출하면 내부 start0 메서드를 통해 커널 스레드 생성 요청을 JNI를 통해 실행한다.</p><p>추가적으로 톰캣과 같은 웹서버가 스레드풀을 사용하는 이유는 JVM 플랫폼 스레드를 생성할때 JNI 를 통해 시스템콜 하는 과정에서 오버헤드가 발생하기에 미리 생성해놓고 재사용하는 방식을 적용한 것이다.</p><h1 id="2-virtual-thread-등장-배경일반-thread-모델의-문제점">2. Virtual Thread 등장 배경(일반 Thread 모델의 문제점)</h1><h2 id="2-1-일반-thread-모델의-한계">2-1. 일반 Thread 모델의 한계</h2><p>기본적인 요청 처리방식은 Thread per request(하나의 요청당 하나의 스레드로 처리하는 방식)이다. 요청 처리량을 높이려면 스레드를 늘려야하나 OS 커널단의 스레드 제약으로 무한히 늘릴 수 없다.</p><h2 id="2-2-blocking-io로-인한-대기-시간-증가">2-2. Blocking I/O로 인한 대기 시간 증가</h2><p>Thread에서 I/O작업을 처리할때 Blocking이 발생하여 대기 시간이 증가하게 된다.</p><h2 id="2-3-reactive-programming-의-한계">2-3. Reactive Programming 의 한계</h2><p>Thread 대기 시간을 줄이기 위해 Webflux 같은 개념이 등장했지만 코드를 작성하고 이해하기 어렵다.</p><h1 id="3-virtual-thread-모델">3. Virtual Thread 모델</h1><p>Virtual Thread는 JDK21에 추가된 경량 스레드 모델이다.</p><p>새로운 유저 스레드가 실행될때마다 OS 커널 스레드를 매번 생성하지 않고, JVM 내부 가상 스레드를 생성하는 방식으로 수십만 ~ 수백만개의 스레드를 동시에 사용할 수 있다.</p><div class="table-wrapper"><table><thead><tr><th>구분<th>Thread<th>Virtual Thread<tbody><tr><td>Stack 사이즈<td>~2MB<td>~10KB<tr><td>생성시간<td>~1ms<td>~1µs<tr><td>컨텍스트 스위칭<td>~100µs<td>~10µs</table></div><p>Thread는 기본적으로 최대 2MB의 스택 메모리 사이즈를 가지기 때문에, 컨텍스트 스위칭 시 메모리 이동량이 크다. 또한 생성을 위해선 커널과 통신하여 스케줄링해야 하므로, 시스템 콜을 이용하기 때문에 생성 비용도 적지 않다.</p><p>하지만 Virtual Thread는 JVM에 의해 생성되기 때문에 시스템 콜과 같은 커널 영역의 호출이 적고, 메모리 크기가 일반 스레드의 1%에 불과하다. 따라서 Thread에 비해 컨텍스트 스위칭 비용이 적다.</p><p><strong>Virtual Thread는 JVM 내부 스케줄링과 Continuation 작업단위를 활용하여 I/O Blocking이 주된 병목인 경우에 처리량을 높일 수 있다.</strong></p><h2 id="jvm-내부-스케줄링">JVM 내부 스케줄링</h2><p>JVM 내부 스케줄링 동작 메커니즘은 다음과 같다.</p><p><strong>1. Virtual Thread 생성시 유저 영역에 생성된다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/51a99782-9c9c-4fd1-8432-d30008e0b764" alt="Image" /></p><p><strong>2. Virtual Thread 실행시 JVM 내부 스케줄러인 ForkJoinPool에 의해 실행된다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/bae283d9-865d-48ba-9055-889a7d264a77" alt="Image" /></p><p>이를 실제 자바 코드로 살펴보면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/6b092ad0-b1f3-417c-bfdc-fb5f82ca7340" alt="Image" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/2b10a65e-7d00-4fc6-8087-9e65c32e9474" alt="Image" /></p><p>VirtualThread의 start 함수를 실행하면 내부 submitRunContinuation 메서드를 실행하여 JVM 내 가상스레드 스케줄러에 runContinuation을 등록한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/aacc1a26-7b27-4287-85d2-4b7afe734731" alt="Image" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/64b60c31-e72b-4b53-9507-4157a8c58bf4" alt="Image" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/f6cc0206-c269-4e0a-acf7-bcf0aef457f5" alt="Image" /></p><p>VirtualThread의 scheduler는 Executor 타입이다. 디폴트 스케줄러는 FokrJoinPool 타입이며 ForkJoinPool 메커니즘으로 스케줄링된다. 또한, static 으로 선언되어 있기에 모든 VirtualThread가 동일한 스케줄러를 공유한다는 것을 알 수 있다.</p><p><strong>3. ForkJoinPool은 Carrier Thread 를 OS단 물리 CPU 코어수만큼 생성한다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/5e21d828-b19d-4da2-83e8-04f0ba63cd40" alt="Image" /></p><p>이를 코드로 확인하면 다음과 같다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/4c83b785-8fd7-4c38-9587-0e531f82446f" alt="Image" /></p><p>디폴트 스케줄러(ForkJoinPool)의 생성 메서드를 확인해보면 Carrier Thread(워커 스레드, 일반 스레드)를 이용 가능한 OS단 프로세서 수만큼 미리 생성해놓는 것을 확인할 수 있다.</p><p><strong>4. ForkJoinPool은 Work Stealing 방식으로 동작하며 작업을 처리한다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/17df49e5-3035-4032-a80e-73311173d7f3" alt="Image" /></p><p>Work Stealing 메커니즘이란 Worker 스레드 각각 Work 큐를 가지고 있고 Work 큐에 태스크를 담아 순차적으로 처리하는 방식이다. 다만, Worker 스레드는 자신의 Work 큐에 작업이 비어있으면 다른 Work 큐로부터 작업을 훔쳐와서 처리한다.</p><h3 id="jvm-내부적인-스케줄링을-해야-하는-이유">✨JVM 내부적인 스케줄링을 해야 하는 이유✨</h3><ul><li>일반 스레드는 생성과 스케줄링시 커널 영역과 시스템콜을 통해 계속 통신해야되고 이 과정에서 오버헤드가 발생하게 된다.<li>Virtual Thread는 커널 영역 접근 없이 단순 Java 객체를 생성하므로 시스템콜이 발생하지 않기에 시스템콜로 인한 오버헤드가 발생하지 않게 된다.</ul><h2 id="캐리어-스레드와-1대n-매핑">캐리어 스레드와 1대N 매핑</h2><p>하나의 Carrier Thread의 Work 큐에 여러 태스크들을 넣고 순차적으로 처리할 수 있다.</p><h2 id="작업-단위-continuation">작업 단위 Continuation</h2><p>오래전부터 사용되던 프로그래밍 패러다임이다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/8bd7add1-5e2b-4d5b-ba2f-0c52bcc23ee5" alt="Image" /></p><p>코틀린의 코루틴도 Continuation을 사용하여 동작한다. 일반적인 Function 은 왼쪽 이미지처럼 Caller가 Function을 실행하면 한 번에 실행 완료후 리턴하게 된다. 서스펜드 Function은 중단이 가능하다. 오른쪽 이미지처럼 코틀린 컴파일러가 코루틴이라는 개념을 적용하여 Caller가 호출하게 되면 어느 정도 실행되다 중단후 다시 실행하는 메커니즘이 가능해진다.</p><p>Continuation은 다음과 같은 특징을 가진다.</p><ul><li>실행가능한 작업흐름<li>중단가능<li>중단 지점부터 재실행 가능</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/e6092da1-cfbc-4a2b-a331-dbc09bf051a2" alt="Image" /></p><p>Continuation의 작업 단위는 다음과 같이 처리된다. Cont1 이 실행되다 중단(yield)되면 중단 지점이 메모리에 기록되어 힙으로 이동하게 되고, 스택엔 그 다음 실행되는 Cont2가 올라와서 실행되게 된다.</p><p>실제 자바 코드를 확인해보면</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/fb554e57-8cca-453c-a0b5-0959ce8cbfe0" alt="Image" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/996b1445-80fc-4ac5-bd74-434d06bff902" alt="Image" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/005983ac-e51c-401c-9a04-995150c04948" alt="Image" /></p><p>runContinuation은 Continuation 실행 람다이다. VirtualThread를 start 할때 실행되는 submitRunContinuation 메서드는 JVM 스케줄러에 실행 작업을 등록하는 것이다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/86fc47c8-d1cd-45b9-b7ad-952783b60e03" alt="Image" /></p><p>즉, 위 이미지와 같이 ForkJoinPool에 실행 작업을 등록하게 되는 것이다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/d0a2285a-5239-41b3-b83e-b9a9b3ed541a" alt="Image" /></p><p><strong>만약 Cont1이 I/O, Sleep으로 인한 interrupt나 작업 완료시 yield 되어 작업이 중단되면 힙메모리로 넘어가게 되고 work 큐에서 제거된다.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/e7dc8f4c-ffbd-4f64-8fe9-6450ef062721" alt="Image" /></p><p><strong>그러면 Cont2가 이어서 작업을 실행하게 된다.(위 메커니즘을 통해 컨텍스트 스위칭 비용을 줄어들게 된다)</strong></p><p>이를 코드로 살펴보면 VirtualThread 클래스 내부 park 메서드가 실행될때 yield 된다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/02207d50-39fb-4ba6-9e8e-a4b6d6210bbf" alt="Image" /></p><p>park 메서드는 package-private으로 되어있는데 LockSupport.park 메서드를 통해 실행시킬수 있으며 스레드가 블락킹된다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/user-attachments/assets/2fec74a8-415c-4dbd-9801-50fa29a3cca7" alt="Image" /></p><h3 id="continuation을-사용-하는-이유">✨Continuation을 사용 하는 이유✨</h3><ul><li>일반 Thread 모델은 작업 중단을 위해 커널 스레드를 중단시킨다.<li>Virtual Thread는 작업 중단을 위해 Continuation yield 시킨다. 작업이 block 되어도 실제 스레드는 중단되지 않고 다른 작업을 처리한다.<li><strong>커널 스레드의 중단이 없으므로 시스템 콜이 발생하지 않게 되며 컨텍스트 스위칭 비용이 낮아지게 된다.</strong></ul><h1 id="4-성능-테스트">4. 성능 테스트</h1><p><img width="684" alt="Image" src="https://github.com/user-attachments/assets/4564b056-c972-4801-b6f0-9c108ca5ba01" /></p><p>일반 Thread 방식에 비해</p><ul><li>I/O Bound 작업은 50% 향상된 처리량 -&gt; NIO로 동작하기에<li>CPU Bound 작업은 7% 낮은 처리량 -&gt; CPU 연산 처리는 플랫폼 스레드 위에서 동작해야 하는데 Virtual Thread를 생성하고 스케줄링하는 비용이 낭비되기에</ul><p>보다 더 자세한 내용은 <a href="https://techblog.woowahan.com/15398">여기</a>를 참고하기 바란다.</p><h1 id="5-virtual-thread-주의사항">5. Virtual Thread 주의사항</h1><h2 id="carrier-thread-블로킹-현상pin">Carrier Thread 블로킹 현상(pin)</h2><p>Carrier Thread가 block 되면 Virtual Thread를 활용 불가하다. Continuation가 yield 되고 Work 큐에서 빠져나오고 다시 스케줄링되는 과정들이 불가능해진다.</p><p>대표적으로 두 케이스에 대해 Virtual Thread는 Carrier Thread로부터 분리되지 않고 고정(pin)되어 위 현상이 발생하게 된다.</p><ul><li>synchronized<li>parrallelStream (병렬 스트림)</ul><p>Virtual Thread의 synchronized, parrallelStream 을 사용하는 부분을 ReentrantLock으로 바꾸면 위 현상을 개선할 수 있다. 스프링이나 몽고DB 는 지원을 하도록 새로운 버전에 적용되어 있지만, MySQL 은 synchronized가 많이 사용되고 있어서 pin 이슈가 많이 발생한다고 한다.</p><p>위 현상은 <code class="language-plaintext highlighter-rouge">-Djdk.tracePinnedThreads=short, full</code> VM Option 으로 감지 가능하다.</p><h2 id="no-pooling">No Pooling</h2><p>Virtual Thread 생성비용이 저렴하기에 풀방식을 사용하지않고 사용할때마다 생성하고 GC처리하면 된다.</p><p>오히려 풀방식을 사용하면 병목이 발생할 수 있다.</p><h2 id="cpu-bound-task">CPU bound task</h2><p>결국 Carrier Thread 위에서 CPU 연산이 수행되므로 성능을 효율적으로 사용하지 못하게 되며 nonblocking의 장점을 활용하지 못하게 된다.</p><h2 id="경량-스레드">경량 스레드</h2><p>ThreadLocal에 무거운 객체를 넣게 되면 Virtual Thread의 이점을 살릴수 없게 된다. 매번 생성하고 매번 파괴하기에 Memory를 사용하는 부분이 계속 늘어나게 된다.</p><p>JDK21의 preview 피처로 ScopedValue 라는 ThreadLocal을 대체하는 개념이 나왔다.</p><h2 id="배압">배압</h2><p>배압 조절 기능이 없다.</p><p>Virtual Thread 는 무제한으로 생성하여 무제한으로 처리하기에 서버가 가질수 있는 최대치를 내려고 할것이다. 그 과정에서 하드웨어 성능이 부족할 수 있기에 충분한 하드웨어 성능테스트가 필요하다.</p><p>그리고 유한 리소스(DB 커넥션 등)의 경우 배압을 조절하도록 설정이 필요하다. DB 커넥션이 부족해서 문제 되는 경우가 존재할 수 있다.</p><h1 id="6-결론">6. 결론</h1><ul><li>Virtual Thread는 가볍고, 빠르고, nonblocking인 경량 스레드다.<li>Virtual Thread는 JVM 스케줄링 + Continuation을 활용하여 내부 메커니즘이 동작한다.<li>Thread per request 사용중이고, I/O blocking time이 주된 병목인 경우 고려할 수 있다.<li>쉽게 적용 가능하다.<ul><li>Reactive가 러닝커브로 부담되는 경우<li>Kotlin coroutine이 러닝커브로 부담되는 경우</ul></ul><h1 id="reference">Reference</h1><ul><li><a href="https://techblog.woowahan.com/15398/">https://techblog.woowahan.com/15398/</a><li><a href="https://waterfogsw.tistory.com/72">https://waterfogsw.tistory.com/72</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backend/'>Backend</a>, <a href='/categories/java/'>Java</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[Java] Virtual Thread - Youngho's Devlog&url=https://jeonyoungho.github.io/posts/virtual-thread/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[Java] Virtual Thread - Youngho's Devlog&u=https://jeonyoungho.github.io/posts/virtual-thread/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[Java] Virtual Thread - Youngho's Devlog&url=https://jeonyoungho.github.io/posts/virtual-thread/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5958719204143086" data-ad-slot="1982371670" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-5958719204143086" data-ad-slot="5918543412"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <script src="https://utteranc.es/client.js" repo="jeonyoungho/jeonyoungho.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/">Kafka 메시지 전달 보장 방식</a><li><a href="/posts/Transactional-Outbox-%ED%8C%A8%ED%84%B4/">Transactional Outbox 패턴</a><li><a href="/posts/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A1%B0%EA%B0%81%ED%99%94/">데이터베이스 인덱스 조각화(Fragmentation)</a><li><a href="/posts/Kafka-DeadLetter-%EA%B4%80%EB%A6%AC/">Kafka DeadLetter 관리</a><li><a href="/posts/Redis-%ED%8A%B9%EC%A7%95/">Redis 특징</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/effectivejava/">effectivejava</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/es6/">es6</a> <a class="post-tag" href="/tags/velopert/">velopert</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/poiemaweb/">poiemaweb</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%83%9D%ED%99%9C%EC%B2%B4%EC%A1%B0-%EC%9B%90%EC%B9%99/"><div class="card-body"> <span class="timeago small" > Sep 14, 2022 <i class="unloaded">2022-09-14T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Java] 객체지향 생활체조 원칙</h3><div class="text-muted small"><p> https://hudi.blog/thoughtworks-anthology-object-calisthenics/ 포스팅 본문에서도 설명하고 있지만 왜(Why?) 이러한 원칙이 나왔는지, 어떠한 문제점들을 해결하고자 하는지에 대해 초점을 맞춰서 읽으면 좋을 것 같다. Why? 에 대해 아주 적절하게 잘 설명되어 있어서 읽으면서 공감이 많이 갔는데, 이...</p></div></div></a></div><div class="card"> <a href="/posts/%EB%B0%98%EB%B3%B5%EB%AC%B8(for%EB%AC%B8-forEach%EB%AC%B8-%EB%B9%84%EA%B5%90)/"><div class="card-body"> <span class="timeago small" > Jun 24, 2021 <i class="unloaded">2021-06-24T14:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Java] 반복문(for문 forEach문 비교)</h3><div class="text-muted small"><p> 프로그래밍을 배우는데 있어서 기본 중의 하나는 반복문이다. 하지만 반복문을 어떻게 사용하느냐가 애플리케이션 성능에 얼마나 영향을 끼치는지 생각을 해보게되었다. Java에서 Collection을 순환할 때 forEach문을 자연스레 사용하고 있었고, 일반 for문하고 가독성 외에는 성능적으로 차이가 없을거라 생각했다. 하지만 for문과 forEach문은...</p></div></div></a></div><div class="card"> <a href="/posts/%EB%B0%98%EB%B3%B5%EB%AC%B8-%EC%9E%91%EC%84%B1-%EC%8B%9C-%EC%95%88-%EC%A2%8B%EC%9D%80-%EC%8A%B5%EA%B4%80/"><div class="card-body"> <span class="timeago small" > Jun 24, 2021 <i class="unloaded">2021-06-24T15:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Java] 반복문 작성 시 안 좋은 습관</h3><div class="text-muted small"><p> 반복문을 작성할 때 안 좋은 습관 1) 불필요하게 조건문에 함수 호출문을 넣는 습관 public void example(List&lt;Integer&gt; numbers) { for (int i = 0; i &lt; numbers.size(); i++) { ... } } 만약 위처럼 코드를 작성하고 numbers의 사이...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/StartWithWhy-%EB%82%B4%EC%9A%A9-%EC%A0%95%EB%A6%AC/" class="btn btn-outline-primary" prompt="Older"><p>Start With Why 내용 정리</p></a> <a href="/posts/Kafka-%EA%B8%B0%EB%B0%98-%EB%8C%80%EA%B7%9C%EB%AA%A8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%B5%9C%EC%A0%81%ED%99%94-Request-Reply-%ED%8C%A8%ED%84%B4-%ED%99%9C%EC%9A%A9-%EC%82%AC%EB%A1%80/" class="btn btn-outline-primary" prompt="Newer"><p>Kafka 기반 대규모 데이터 동시성 최적화: Request-Reply 패턴 활용 사례</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/jeonyoungho_o">jeonyoungho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/effectivejava/">effectivejava</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/es6/">es6</a> <a class="post-tag" href="/tags/velopert/">velopert</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/poiemaweb/">poiemaweb</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://jeonyoungho.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
