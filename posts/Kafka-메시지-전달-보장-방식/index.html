<!DOCTYPE html><html lang="ko" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Kafka 메시지 전달 보장 방식" /><meta name="author" content="jeonyoungho" /><meta property="og:locale" content="ko" /><meta name="description" content="메시지 큐 시스템을 다룰 때 중요하게 고민해야되는 부분 중 하나는 ‘메시지의 중복과 유실 문제’이다." /><meta property="og:description" content="메시지 큐 시스템을 다룰 때 중요하게 고민해야되는 부분 중 하나는 ‘메시지의 중복과 유실 문제’이다." /><link rel="canonical" href="https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/" /><meta property="og:url" content="https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/" /><meta property="og:site_name" content="Youngho’s Devlog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-08-04T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kafka 메시지 전달 보장 방식" /><meta name="twitter:site" content="@jeonyoungho_o" /><meta name="twitter:creator" content="@jeonyoungho" /><meta name="google-site-verification" content="eonGeSiIVfF48EnFoJqakC7h2hUzgqxFNJaxkfPiGr0" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"jeonyoungho"},"dateModified":"2025-08-06T21:03:29+09:00","datePublished":"2025-08-04T00:00:00+09:00","description":"메시지 큐 시스템을 다룰 때 중요하게 고민해야되는 부분 중 하나는 ‘메시지의 중복과 유실 문제’이다.","headline":"Kafka 메시지 전달 보장 방식","mainEntityOfPage":{"@type":"WebPage","@id":"https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/"},"url":"https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/"}</script><title>Kafka 메시지 전달 보장 방식 | Youngho's Devlog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Youngho's Devlog"><meta name="application-name" content="Youngho's Devlog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-RF6ZGDWXV1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-RF6ZGDWXV1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5958719204143086" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/youngho_employee_pic.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Youngho's Devlog</a></div><div class="site-subtitle font-italic">curios developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/jeonyoungho" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/jeonyoungho_o" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['yhjun1000','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Kafka 메시지 전달 보장 방식</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"> <ins class="adsbygoogle" style="display:block; margin-top: 30px;" data-ad-client="ca-pub-5958719204143086" data-ad-slot="1982371670" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kafka 메시지 전달 보장 방식</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> jeonyoungho </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 4, 2025, 12:00 AM +0900" prep="on" > Aug 4 <i class="unloaded">2025-08-04T00:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 6, 2025, 9:03 PM +0900" prefix="Updated " > Aug 6 <i class="unloaded">2025-08-06T21:03:29+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5128 words">28 min</span></div></div><div class="post-content"><p>메시지 큐 시스템을 다룰 때 중요하게 고민해야되는 부분 중 하나는 <strong>‘메시지의 중복과 유실 문제’</strong>이다.</p><p>이와 관련된 메시지 큐 시스템의 <strong>‘메시지 전달 보장 방식’</strong>과 <strong>‘Kafka 에서 각각 어떻게 지원하는지’</strong>에 대해 알아보자.</p><h1 id="메시지-전달-보장-방식message-delivery-semantics">메시지 전달 보장 방식(Message Delivery Semantics)</h1><p>메시지 전달 보장 방식은 다음과 같은 3가지가 존재한다.</p><ul><li>At most once: 메시지가 최대 한 번 전달됨을 보장 (중복은 발생하지 않지만, 유실이 있을 수 있음)<li>At least once: 메시지가 최소 한 번 전달됨을 보장 (유실은 없지만, 중복이 있을 수 있음)<li>Exactly once: 메시지가 정확히 한 번만 전달됨을 보장 (중복도 없고, 유실도 없음)</ul><p>아래로 갈수록 데이터 무결성은 높아지지만, 트랜잭션 관리나 중복 감지 등의 비용이 발생하기에 성능은 떨어질 수 있다. 그렇기 때문에 무조건 높은 수준을 사용해야 하는 것이 아닌, 애플리케이션 혹은 메시지 특성에 따라 적절하게 선택하는 것이 중요하다.</p><p>아래에서 각 방식에 대해 사용사례와 함께 살펴보자.</p><h2 id="1-at-most-once">1. At most once</h2><p>메시지가 최대 한 번 전달됨을 보장하는 방식이다. 최대 한 번 전달됨을 보장하기에 중복은 발생하지 않지만, 유실이 발생할 수는 있다.</p><p><strong>메시지가 유실되어도 치명적이지 않으며, 컨슈머의 높은 처리량 or 퍼포먼스가 중요한 요소일때 사용된다.</strong> 대표적인 사용 사례는 다음과 같다.</p><ul><li>시스템 로그 수집, 사용자 활동 로그, 실시간 서버 메트릭 수집 작업에서는 일부 데이터가 유실되어도 전체 추세 분석에 큰 영향이 없음<li>실시간 데이터 스트리밍(예: IoT 센서 데이터, 라이브 분석)에서는 일부 데이터 손실보다 낮은 지연 시간과 높은 처리량이 더 중요할 수 있음</ul><h2 id="2-at-least-once">2. At least once</h2><p>메시지가 최소 한 번 전달됨을 보장하는 방식이다. ‘최소 한 번 전달됨을 보장’ 이라는 부분에서 알 수 있듯이 여러 번 중복되어 발행될 수 있으며, 유실은 없게 된다.</p><p><strong>주로 메시지 유실이 발생하지 않아야 하며, exactly-once 방식보다 성능을 우서신하는 경우에 주로 사용된다. 구현 복잡도와 성능 오버헤드가 적으면서도 높은 신뢰성을 제공하기 때문이다.</strong> 대표적인 사용 사례는 다음과 같다.</p><ul><li>데이터 손실을 피하는 것이 최우선일 때 적합함<li>중복이 허용되거나 멱등성 로직 구현이 가능한 시나리오에 적합함. 예를 들어 로그 수집, 분석 이벤트, 메트릭 처리 등에서는 중복된 데이터가 들어와도 크게 문제가 없거나 후에 중복 제거를 통해 정합성을 맞출 수 있다.</ul><blockquote><p><strong>Note</strong>: 중복으로 인한 영향이 큰 경우(ex. 금전 거래)에는 추가적인 멱등성 로직을 구현하거나, Exactly-Once 방식을 고려해야 한다.</p></blockquote><h2 id="3-exactly-once">3. Exactly once</h2><p>메시지가 정확히 딱 한 번만 전달됨을 보장하는 방식이다. 중복도 유실도 허용하지 않는다.</p><p>At-least-once 방식 + 컨슈머 멱등성 로직 구현도 하나의 메시지가 정확히 한 번만 비즈니스 로직이 실행되도록 할 수 있다.</p><p>그렇다면 ‘Exactly once’ 와 ‘At-least-once 방식에 + 컨슈머 멱등성 로직 구현’의 정확한 차이는 무엇일까? <strong>바로 ‘메시지 큐 시스템’ 레벨에서의 한 번만 전달함을 보장하는지의 관점으로 구분할 수 있다.</strong></p><p><strong>주로 정확히 한 번만 발행되어 처리 됨을 보장하기 위해 사용한다. 다만 가장 높은 구현 복잡도와 성능 비용이 수반되는 점을 고려해서 적용해야 한다. 대표적인 사례는 다음과 같다.</strong></p><ul><li>금융 거래, 결제 시스템, 재고 관리, 은행 계좌 이체, 제품 과금과 직결된 액세스 로그 등 중복이나 손실이 치명적인 케이스<li>end-to-end 정합성이 요구되는 파이프라인. 예를 들어 카프카 스트림즈(Kafka Streams) 애플리케이션이나 ETL 파이프라인 등에서는 입력부터 출력까지 한 번씩만 처리하도록 Exactly-Once (처리) 모드를 활용할 수 있음</ul><h1 id="kafka-에서의-메시지-전달-보장-방식message-delivery-semantics">Kafka 에서의 메시지 전달 보장 방식(Message Delivery Semantics)</h1><p>Kafka는 링크드인에서 웹사이트의 로그를 활용하여 사용자 활동을 추적하기 위한 용도, 즉 실시간 데이터 파이프라인을 구성하기 위해 만들어졌다.</p><p>그러다보니 처리량이 높고 데이터 중복이 약간 발생하더라도 메시지가 유실되지 않는 At least once 방식을 구축하는 것이 중요했다.</p><p>Kafka가 오픈 소스로 성장하며, 더 높은 메세지 전달 보장 수준에 대한 필요성이 생겼다. 그래서 현재 Kafka는 세 가지 전달 보장 수준을 모두 구현할 수 있다.</p><p>Kafka에서 각 메시지 전달 보장 방식의 구현(설정) 방법을 알아보자. 프로듀서 측면과 컨슈머 측면에서 어떻게 전송 보장을 하는지 각각 살펴봐야한다.</p><h2 id="1-kafka에서-no-guarantee-방식중복-o-유실-o">1. Kafka에서 No guarantee 방식(중복 O, 유실 O)</h2><blockquote><p><strong>Kafka v2.8 이하 기준의 설명이다. 참고로 3.0 부터는 acks=all, enable.idempotence=true가 디폴트 설정이다.</strong> 각 전달 보장 방식들에서 하나씩 설정들을 추가해나가는 것을 표현하고자 해당 버전을 기준으로 설명하였다.</p></blockquote><p>No guarantee 방식은 메시지의 유실과 중복을 보장하지 않는 방식이다. 별도 설정 없이 카프카를 사용할때 메세지가 유실될 수도 있고, 중복이 발생할 수 있다. 왜 그런 현상이 나타나는지 먼저 프로듀서 측면에서 살펴보자.</p><h3 id="kafka-프로듀서-측면의-no-guarantee-방식중복-o-유실-o">Kafka 프로듀서 측면의 No guarantee 방식(중복 O, 유실 O)</h3><p>Kafka 프로듀서의 기본 acks 설정은 1이다. 즉, follower 파티션의 복제 여부와 상관없이 리더 파티션에만 정상적으로 메시지가 수신되면 정상 수신되었다는 acks 응답을 주게된다. 따라서 leader 파티션이 프로듀서의 메세지를 받고 acks 응답을 준 후 follower로 복제하기 전에 다운되면 해당 메세지는 acks 응답을 주었음에도 유실된다.</p><p>중복 메세지 발생 여부는 프로듀서의 retry 설정에 따라 다르다. retry를 하도록 설정되어있으면 중복 메세지가 발생할 수 있다. 특히 기본 설정에서는 멱등성 기능이 비활성화되어 있어서, 동일 메시지가 여러 번 발행될 수 있다.</p><h3 id="kafka-컨슈머-측면의-no-guarantee-방식중복-o-유실-o">Kafka 컨슈머 측면의 No guarantee 방식(중복 O, 유실 O)</h3><p>컨슈머는 기본적으로 enable.auto.commit=true로 설정되어 있기 때문에 주기적으로 오프셋 커밋이 자동으로 발생한다. 그러다보니 자동 커밋 주기가 5초인데, 컨슈머가 메세지를 처리하는 과정이 5초를 초과하면 메세지 처리가 완료되기 전에 오프셋 커밋이 일어나게 된다. 만약 커밋 이후 해당 메세지 처리 과정에서 에러가 발생하게 되면 메시지는 유실된다.</p><p>컨슈머가 메세지를 처리 후 커밋 전에 Kafka 브로커의 장애가 발생하여 다운되면, 컨슈머가 재시작될 때 이전 오프셋부터 메세지를 다시 읽기 때문에 중복 소비가 발생할 수 있다.</p><h2 id="2-kafka에서-at-most-once-방식중복-x-유실-o">2. Kafka에서 At most once 방식(중복 X, 유실 O)</h2><p>그러면 어떻게 설정을 바꾸면 메세지가 최대 한 번(0번 혹은 1번만) 처리되도록 보장해줄 수 있을까?</p><h3 id="kafka-프로듀서-측면의-at-most-once-방식중복-x-유실-o">Kafka 프로듀서 측면의 At most once 방식(중복 X, 유실 O)</h3><p>프로듀서 측면에서는 메세지 중복 발행만 방지하면 된다. 메세지를 한 번만 보내고 브로커가 메세지를 잘 받았는지 안받았는지는 신경쓰지 않아도 된다.</p><p>그래서 retries=0으로 설정해주고, acks=all 이 아닌 경우에는 At most once라고 볼 수 있다. 예를 들어, retries=0, acks=1로 지정할 경우 프로듀서는 follower 파티션의 복제에 실패하더라도 무조건 1번만 발행되도록 할 수 있기에 최대 한 번의 전달이 가능하게 되며 중복이 발생하지 않게 된다.</p><h3 id="kafka-컨슈머-측면의-at-most-once-방식중복-x-유실-o">Kafka 컨슈머 측면의 At most once 방식(중복 X, 유실 O)</h3><p>컨슈머 측면에서는 자동 커밋이 활성화되어 있으면 중복 소비를 막기는 어렵다. 중복 소비를 반드시 막아야하는 상황이라면 수동 커밋<code class="language-plaintext highlighter-rouge">(enable.auto.commit=false)</code>으로 설정 후 소비후 비즈니스 로직이 실행되기 전에 오프셋을 커밋하는 방법이 있다. 이렇게 하면 컨슈머가 재시작되어도 이미 해당 오프셋은 커밋되었기 때문에 유실은 발생하더라도 중복 소비는 발생하지 않는다.</p><h2 id="3-kafka에서-at-least-once-방식중복-o-유실-x">3. Kafka에서 At least once 방식(중복 O, 유실 X)</h2><p>가장 자주 쓰이는 At least once 방식에 대해 살펴보자.</p><h3 id="kafka-프로듀서-측면의-at-least-once-방식중복-o-유실-x">Kafka 프로듀서 측면의 At least once 방식(중복 O, 유실 X)</h3><p>프로듀서가 발행하는 메세지가 유실되면 안된다. 그렇기 때문에 <code class="language-plaintext highlighter-rouge">acks=all</code>로 모든 follower 파티션에 복제가 잘 이루어졌음을 보장해야한다.</p><p>프로듀서는 메세지가 커밋되었다는 응답(ack)을 받지 못하면 메세지를 재전송(retry)한다. 그렇기에 메세지는 중복이 발생할 수 있다.</p><h3 id="kafka-컨슈머-측면의-at-least-once-방식중복-o-유실-x">Kafka 컨슈머 측면의 At least once 방식(중복 O, 유실 X)</h3><p>컨슈머가 오토 커밋 설정인 경우에는 유실이나 중복이 발생할 수 있다. 그래서 수동 커밋 설정으로 바꾸되, 메세지를 처리 후 오프셋을 커밋하면 유실 문제를 방지할 수 있다.</p><p>하지만 중복 소비는 발생할 수 있다. 예를 들어, 컨슈머가 오프셋을 커밋하지 못하고 죽은 경우(JVM OOM, Container 강제 종료 등)에는 다른 컨슈머 프로세스가 이전 오프셋부터 소비하기 때문에 중복 소비될 수 있다. 중복 소비가 발생하긴 하지만, 유실이 발생하진 않기에 At least once라고 볼 수 있다.</p><blockquote><p><strong>Note</strong>: 만약 중복을 방지하고자 한다면, 애플리케이션 레벨에서 단 한 번만 메시지가 처리되도록 보장하거나, 멱등하게 비즈니스 로직을 구현해야 한다. 예를 들어, 주문 애플리케이션을 생각해보자. 컨슈머가 주문 메시지를 읽어서 결제 처리를 완료후 오프셋 커밋전에 서버가 다운되면, 해당 주문 메시지는 처리됐음에도 불구하고 커밋되지 않았기 때문에 재시작된 컨슈머에 의해 중복 처리된다. 이로 인해 동일한 주문에 대해 두 번 결제가 시도되거나, 확인 메일이 중복 발송되는 문제가 생길 수 있다. 참고로 <a href="https://curiousjinan.tistory.com/entry/kafka-consumer-inbox-pattern">Inbox 패턴</a>을 활용하여 메시지가 단 한 번만 처리되도록 보장하는 것도 가능하기에 참고해두면 좋다.</p></blockquote><h2 id="4-kafka에서-exactly-once-방식중복-x-유실-x">4. Kafka에서 Exactly once 방식(중복 X, 유실 X)</h2><p>마지막으로 가장 높은 수준인 Exactly Once를 보장하기 위한 구현 방법을 알아보자.</p><h3 id="kafka-프로듀서-측면의-exactly-once-방식중복-x-유실-x">Kafka 프로듀서 측면의 Exactly once 방식(중복 X, 유실 X)</h3><p>acks=all 설정을 해주어 유실을 방지해야 한다. 그리고, 메세지의 중복도 없어야하기에 <code class="language-plaintext highlighter-rouge">enable.idempotence=true</code> 로 설정하여 멱등성을 보장해야한다. 프로듀서 멱등성 설정이 적용되면 메시지를 발행할때 프로듀서ID와 시퀀스 번호를 함께 전달하게 되고, Kafka 브로커가 이를 활용하여 중복 메시지를 필터링하게 된다.</p><p>또한, 프로듀서가 여러 파티션에 메시지를 발행할때 트랜잭션이 필요하기 때문에 <code class="language-plaintext highlighter-rouge">transactional.id</code>를 지정해줘야한다. 이를 통해 여러 파티션간 메시지 발행에 원자성을 보장함으로써 Exactly once를 보장한다. 트랜잭션 처리가 왜 되어야하는지는 아래 컨슈머 측면에서 더 알아보자.</p><h3 id="kafka-컨슈머-측면의-exactly-once-방식중복-x-유실-x">Kafka 컨슈머 측면의 Exactly once 방식(중복 X, 유실 X)</h3><p><strong>컨슈머는 수동 커밋을 사용해도 유실을 막거나, 애플리케이션 로직 단에서 중복 처리만 막을 수 있지, 무조건 1번만 메시지가 소비되는 것을 보장할 수 없다. 즉, 정확히 한 번만 메시지가 처리되는 것을 보장하기 위해서는 ‘수동 커밋 설정 + 비즈니스 로직 완료 후 커밋 + 멱등한 비즈니스 로직 구현’이 필요하다.</strong></p><p>만약 트랜잭션 사용 프로듀서가 있는 경우엔 별도 트랜잭션 설정이 필요하게 된다. 프로듀서가 여러 파티션에 메시지를 발행할때 원자적으로 TX 커밋이 이뤄져야만, 컨슈머가 모든 메시지를 처리하도록 말이다. 그래서 수동 커밋을 하고 <code class="language-plaintext highlighter-rouge">isolation.level=read_committed</code>로 설정해줘야한다. read_committed이어야지 TX 커밋 후에만 메세지가 컨슈머에게 노출이 되어서 중복 메세지나 트랜잭션이 abort 된 메세지를 소비하지 않게 된다. <a href="https://docs.confluent.io/platform/current/installation/configuration/consumer-configs.html#isolation-level">참고로 isolation.level의 디폴트 값은 read_uncommitted이다.</a></p><p>트랜잭션에 대한 더 자세한 내용은 해당 <a href="https://www.youtube.com/watch?v=Ki2D2o9aVl8">Confluent 영상</a>을 참고하면 좋다.</p><h1 id="실무-활용-사례">실무 활용 사례</h1><p><a href="https://oliveyoung.tech/2024-10-16/oliveyoung-scm-oms-kafka/">올리브영 주문 관리 시스템(WMS)의 Kafka 메시지 중복 및 유실 문제 해결 사례</a></p><h1 id="kafka-리밸런싱과-컨슈머의-메시지-중복-소비-문제">Kafka 리밸런싱과 컨슈머의 메시지 중복 소비 문제</h1><p>Kafka 리밸런싱이 발생할때, 컨슈머의 메시지 중복 소비 문제를 주의해야 한다.</p><p>리밸런싱이 발생하게 되면, 컨슈머는 오프셋을 커밋하지 못한채 중단되고 새로 할당된 컨슈머에 의해 중복 처리될 수 있다.</p><p>이를 해결 혹은 리스크를 줄일 수 있는 방법은 다음과 같다.</p><h2 id="1-maxpollrecords-조정-해결x-리스크-줄임">1) max.poll.records 조정 (해결X, 리스크 줄임)</h2><ul><li>리밸런싱 시간 단축: 리밸런싱 발생시 컨슈머들의 JoinGroup 요청을 빠르게 할 수 있기에<li>Poll 지연에 의한 리밸런싱 발생 가능성 감소: 일정 시간(<code class="language-plaintext highlighter-rouge">max.poll.interval.ms</code>) 안에 Poll 요청을 보내지 않으면 리밸런싱이 일어나는데, 이러한 가능성을 줄일 수 있음<li>메시지 중복 소비 리스크 감소: 오프셋 커밋 단위가 줄어들기에, 메시지 중복 소비의 갯수를 줄일 수 있음<li><strong>만약 메시지 처리 성능을 높이고자 할 경우, 다중 파티션 + Concurrency 활용</strong><li>대부분의 서비스에서는 1로 지정해도 큰 이슈가 없을거지만, 메시지 처리 성능이 매우 중요한 서비스일 경우 ‘배치 처리’ + ‘애플리케이션단의 중복 방지 로직’의 구현이 반드시 필요하다.</ul><blockquote><p>max.poll.records : The maximum number of records returned in a single call to poll(). Note, that max.poll.records does not impact the underlying fetching behavior. The consumer will cache the records from each fetch request and returns them incrementally from each poll. (참고: https://kafka.apache.org/documentation/)</p></blockquote><p>참고로 Kafka 공식 문서를 찾아보면, <code class="language-plaintext highlighter-rouge">max.poll.records</code> 는 컨슈머의 fetch 동작에 영향을 미치지 않는다고 한다. 컨슈머는 비동기적으로 메시지를 fetch 하여 메모리에 캐시해두고, 지정된 갯수만큼 poll()을 통해 꺼내와서 처리하는 구조라고 이해할 수 있다.</p><h2 id="2-수동-커밋-사용-해결x-리스크-줄임">2) 수동 커밋 사용 (해결X, 리스크 줄임)</h2><ul><li>오토 커밋 방식으로 인해 컨슈머가 메시지 처리를 완료하지 못했으나, 오프셋이 커밋되는 문제 방지<li>예를 들어, 컨슈머가 메시지 500개 처리 도중 400개만 처리 완료한 상태에서 <code class="language-plaintext highlighter-rouge">max.poll.interval.ms</code> 시간이 지나 리밸런싱이 발생하여 메시지 중복 소비 문제가 발생할 수 있음<li>만약 <code class="language-plaintext highlighter-rouge">max.poll.records</code> 는 1, <code class="language-plaintext highlighter-rouge">AckMode</code>를 <code class="language-plaintext highlighter-rouge">BATCH</code> 또는 <code class="language-plaintext highlighter-rouge">MANUAL</code>로 지정하게 되면, 한 개씩 메시지를 가져와서 처리 후 커밋하게 되므로, 중복 소비 문제에 대한 영향을 줄일 수 있다.</ul><h2 id="3-중복-메시지-소비-방어-로직-구현해결o">3) 중복 메시지 소비 방어 로직 구현(해결O)</h2><ul><li>카프카 설정만으로 중복 메시지 소비에 대한 리스크를 완벽하게 관리하는 것은 쉽지 않음<li>중복 메시지 소비 문제가 크리티컬한 서비스라면 애플리케이션 레벨에서 방어 로직을 반드시 구현해야 함</ul><p>이와 관련하여 아래 레퍼런스들을 참고하면 좋다. <u>잘못된 내용이 있을 수 있으니 주의할 필요가 있다.</u></p><ul><li><a href="https://junuuu.tistory.com/m/796">https://junuuu.tistory.com/m/796</a><li><a href="https://techblog.gccompany.co.kr/카프카-컨슈머-그룹-리밸런싱-kafka-consumer-group-rebalancing-5d3e3b916c9e">https://techblog.gccompany.co.kr/카프카-컨슈머-그룹-리밸런싱-kafka-consumer-group-rebalancing-5d3e3b916c9e</a></ul><h1 id="정리">정리</h1><h2 id="메시지-큐-시스템의-메시지-전달-보장-방식message-delivery-semantics">메시지 큐 시스템의 메시지 전달 보장 방식(Message Delivery Semantics)</h2><div class="table-wrapper"><table><thead><tr><th>보장 방식<th>설명<th>메시지 유실/중복 여부<tbody><tr><td><strong>At most once</strong><td>메시지가 최대 한 번 전달됨을 보장<td>중복 X, 유실 O<tr><td><strong>At least once</strong><td>메시지가 최소 한 번 전달됨을 보장<td>중복 O, 유실 X<tr><td><strong>Exactly once</strong><td>메시지가 정확히 한 번만 전달됨을 보장<td>중복 X, 유실 X</table></div><h2 id="프로듀서-측-설정">프로듀서 측 설정</h2><div class="table-wrapper"><table><thead><tr><th>보장 수준<th>설정<th>설명<tbody><tr><td><strong>At most once</strong><td>- <code class="language-plaintext highlighter-rouge">acks=0</code><br />- <code class="language-plaintext highlighter-rouge">retries=0</code><td>메시지의 중복 발행을 방지하며, Kafka 브로커가 메시지를 수신했는지 확인하지 않음<tr><td><strong>At least once</strong><td>- <code class="language-plaintext highlighter-rouge">acks=all</code><td>메시지 유실을 방지하며, 메시지를 한 번 이상 전송할 수 있음<tr><td><strong>Exactly once</strong><td>- <code class="language-plaintext highlighter-rouge">acks=all</code><br />- <code class="language-plaintext highlighter-rouge">enable.idempotence=true</code><br />- <code class="language-plaintext highlighter-rouge">transactional.id</code><td>멱등성 프로듀서 설정과 트랜잭션을 사용하여 메시지의 중복 발행과 유실을 방지함</table></div><h2 id="컨슈머-측-설정">컨슈머 측 설정</h2><div class="table-wrapper"><table><thead><tr><th>보장 수준<th>설정<th>설명<tbody><tr><td><strong>At most once</strong><td>- <code class="language-plaintext highlighter-rouge">enable.auto.commit=false</code><br />- 수동 커밋 모드에서 메세지를 처리 전 오프셋을 커밋함<td>메시지를 처리하지 못할 경우, 해당 메시지가 유실될 수 있음<tr><td><strong>At least once</strong><td>- <code class="language-plaintext highlighter-rouge">enable.auto.commit=false</code><br />- 수동 커밋 모드에서 메시지를 처리 후 오프셋을 커밋함<td>오프셋을 커밋하지 못한 경우, 메시지 중복 처리가 발생할 수 있음<tr><td><strong>Exactly once</strong><td>- <code class="language-plaintext highlighter-rouge">enable.auto.commit=false</code><br />- <code class="language-plaintext highlighter-rouge">isolation.level=read_committed</code><br />- 트랜잭션 커밋된 메시지만 소비<td>메시지의 유실과 중복을 방지하며, TX 설정을 통해 프로듀서의 커밋된 메시지만 소비함</table></div><h1 id="reference">Reference</h1><ul><li><a href="https://sookim1110.github.io/posts/kafka-message-delivery-semantics/#at-most-once">https://sookim1110.github.io/posts/kafka-message-delivery-semantics/#at-most-once</a><li><a href="https://curiousjinan.tistory.com/entry/kafka-message-delivery-guarantees">https://curiousjinan.tistory.com/entry/kafka-message-delivery-guarantees</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backend/'>Backend</a>, <a href='/categories/kafka/'>Kafka</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kafka/" class="post-tag no-text-decoration" >kafka</a> <a href="/tags/at-least-once/" class="post-tag no-text-decoration" >at-least-once</a> <a href="/tags/at-most-once/" class="post-tag no-text-decoration" >at-most-once</a> <a href="/tags/exactly-once/" class="post-tag no-text-decoration" >exactly-once</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kafka 메시지 전달 보장 방식 - Youngho's Devlog&url=https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kafka 메시지 전달 보장 방식 - Youngho's Devlog&u=https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kafka 메시지 전달 보장 방식 - Youngho's Devlog&url=https://jeonyoungho.github.io/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5958719204143086" data-ad-slot="1982371670" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-5958719204143086" data-ad-slot="5918543412"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <script src="https://utteranc.es/client.js" repo="jeonyoungho/jeonyoungho.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Kafka-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%84%EB%8B%AC-%EB%B3%B4%EC%9E%A5-%EB%B0%A9%EC%8B%9D/">Kafka 메시지 전달 보장 방식</a><li><a href="/posts/Transactional-Outbox-%ED%8C%A8%ED%84%B4/">Transactional Outbox 패턴</a><li><a href="/posts/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A1%B0%EA%B0%81%ED%99%94/">데이터베이스 인덱스 조각화(Fragmentation)</a><li><a href="/posts/Kafka-DeadLetter-%EA%B4%80%EB%A6%AC/">Kafka DeadLetter 관리</a><li><a href="/posts/Redis-%ED%8A%B9%EC%A7%95/">Redis 특징</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/effectivejava/">effectivejava</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/es6/">es6</a> <a class="post-tag" href="/tags/velopert/">velopert</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/poiemaweb/">poiemaweb</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Kafka-DeadLetter-%EA%B4%80%EB%A6%AC/"><div class="card-body"> <span class="timeago small" > May 11 <i class="unloaded">2025-05-11T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kafka DeadLetter 관리</h3><div class="text-muted small"><p> MSA 환경에서 이벤트 기반 아키텍처(EDA)를 적용할때 Kafka가 주로 사용되곤 한다. 카프카 Consumer 메시지 처리 실패시 dead-letter를 어떻게 관리하고 재시도 전략을 수립하면 좋을지 깊게 고찰해보자. (잘못된 내용 및 피드백은 코멘트로 남겨주시면 최대한 빠르게 확인해보겠습니다😃) 가장 간단하게는 spring-kafka에서 제공...</p></div></div></a></div><div class="card"> <a href="/posts/Kafka-%EA%B0%9C%EC%9A%94/"><div class="card-body"> <span class="timeago small" > Jun 30, 2021 <i class="unloaded">2021-06-30T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kafka 개요</h3><div class="text-muted small"><p> MessageQueue 데이터를 전송하는 애플리케이션과 데이터를 수신 받는 애플리케이션의 개수가 늘어날 수 록 데이터 전송라인이 많아 지게 됨 데이터 전송라인이 많아지면 배포와 장애에 대응하기 어려움 데이터를 전송할 때의 프로토콜의 파편화가 심각해짐 추후 데이터의 포맷내부에 변경이 있을 때 유지보수하기 매우 어려워짐 카프카는 이런 ...</p></div></div></a></div><div class="card"> <a href="/posts/Kafka-%EA%B8%B0%EB%B3%B8-%EC%8B%A4%EC%8A%B5/"><div class="card-body"> <span class="timeago small" > Jun 30, 2021 <i class="unloaded">2021-06-30T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kafka 기본 실습</h3><div class="text-muted small"><p> Kafka-실습1 Kafka 설치 1) homebrew를 통한 kafka 설치 brew install kafka Kafka 실행 2) Kafka를 실행하기 전 zookeeper를 먼저 시작 brew services start zookeeper 3) Kafka 시작 brew services start kafka 4) Kafka에...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Kafka-%EB%A6%AC%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%B0%A9%EC%8B%9D%EA%B3%BC-%ED%8C%8C%ED%8B%B0%EC%85%98-%ED%95%A0%EB%8B%B9-%EC%A0%84%EB%9E%B5/" class="btn btn-outline-primary" prompt="Older"><p>Kafka 리밸런싱 방식과 파티션 할당 전략</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/jeonyoungho_o">jeonyoungho</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/jpa/">jpa</a> <a class="post-tag" href="/tags/effectivejava/">effectivejava</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/es6/">es6</a> <a class="post-tag" href="/tags/velopert/">velopert</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/poiemaweb/">poiemaweb</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://jeonyoungho.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
