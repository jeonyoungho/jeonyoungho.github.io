---
title: "μΈλ±μ¤ μ΅°κ°ν™”"
date: 2025-05-31 +0800
categories: [Backend, Database]
tags: [database, index]
toc: true
comments: true
published: false
---

λ°μ΄ν„°κ°€ λ§μ€ ν…μ΄λΈ”μ—μ„ μΏΌλ¦¬ μ„±λ¥μ„ λ†’μ΄κΈ° μ„ν•΄ μ£Όλ΅ μΈλ±μ¤λ¥Ό ν™μ©ν•λ‹¤.

μΈλ±μ¤λ¥Ό ν™μ©ν•λ‹¤ν•΄λ„ λ°μ΄ν„°κ°€ κ³„μ† μ“μ΄λ‹¤λ³΄λ©΄ μΏΌλ¦¬ μ†λ„κ°€ λλ ¤μ§ μ μλ‹¤.

μ΄μ™€ κ΄€λ ¨λ μΈλ±μ¤ μ΅°κ°ν™”(Fragmentation) λ¬Έμ μ™€ κ·Έ ν•΄κ²°λ°©λ²• λ° μ΄λ¥Ό μ§€μ—°μ‹ν‚¬ μ μλ” λ°©λ²•μ— λ€ν•΄ μ •λ¦¬ν•΄λ³΄μ.

# 1. μΈλ±μ¤ μ΅°κ°ν™”(Fragmentation)λ€?
MySQL(MariaDB)μ—μ„ μΈλ±μ¤ νμ΄μ§€κ°€ λΉ„ν¨μ¨μ μΌλ΅ λ°°μΉλλ” ν„μƒμ„ λ§ν•λ‹¤.

μΈλ±μ¤ λν• λ¬Όλ¦¬μ μΈ νμ΄μ§€λ΅ κ΄€λ¦¬λλ”λ° μΈλ±μ¤λ΅ κ΄€λ¦¬λλ” λ°μ΄ν„°μ μ–‘μ΄ λ§μ•„μ§€λ‹¤λ³΄λ©΄ μ—¬λ¬ νμ΄μ§€λ΅ λ‚λ‰μ–΄ κ΄€λ¦¬λκ² λκ³  μ΄λ΅ μΈν•΄ μµν‹°λ§μ΄μ €κ°€ μ—¬λ¬ νμ΄μ§€λ¥Ό μ°Ύλ‹¤λ³΄λ‹ μ†λ„κ°€ μ €ν•λκ² λλ‹¤.

μ΅°κ°ν™”κ°€ λ°μƒν•λ” μ£Όμ” μ›μΈμ€ λ‹¤μκ³Ό κ°™λ‹¤.
- INSERT(μ‚½μ…): μƒλ΅μ΄ λ°μ΄ν„°λ¥Ό μ‚½μ…ν•λ©° κΈ°μ΅΄ νμ΄μ§€ κ³µκ°„μ΄ λ¶€μ΅±ν•λ©΄ μƒλ΅μ΄ νμ΄μ§€κ°€ μƒμ„±λ¨
- UPDATE(μμ •): λ°μ΄ν„° ν¬κΈ°κ°€ μ»¤μ§€λ©΄ μ›λ μλ νμ΄μ§€μ— κ³µκ°„μ΄ λ¶€μ΅±ν•΄μ§€κ³ , μΌλ¶€ λ°μ΄ν„°κ°€ λ‹¤λ¥Έ νμ΄μ§€λ΅ μ΄λ™ν•¨
- DELETE(μ‚­μ ): μΌλ¶€ λ°μ΄ν„°κ°€ μ‚­μ λλ©° νμ΄μ§€μ— λΉ κ³µκ°„μ΄ μƒκΈ°κ² λ¨

μ΅°κ°ν™”κ°€ μ‹¬ν•΄μ§€λ©΄ κ²€μƒ‰ μ†λ„κ°€ λλ ¤μ§€κ³ , μΏΌλ¦¬ μ„±λ¥μ΄ μ €ν•λλ‹¤.

## 1-1. μΈλ±μ¤ μ΅°κ°ν™”(Fragmentation) ν™•μΈ λ°©λ²•
MySQLμ—μ„λ” `information_schema.tables` λλ” `SHOW TABLE STATUS` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ μΈλ±μ¤ μ΅°κ°ν™”λ¥Ό ν™•μΈν•  μ μλ‹¤.

```sql
-- 1. SHOW TABLE STATUS λ…λ Ήμ–΄λ¥Ό ν†µν•΄ ν™•μΈ
SHOW TABLE STATUS LIKE 'orders';

-- 2. information_schema.tables λ¥Ό ν†µν•΄ ν™•μΈ
SELECT
    table_name,
    ROUND((data_free / (data_length + index_length + data_free)) * 100, 2) AS fragmentation_percentage,
    engine,
    data_length,
    index_length,
    data_free
FROM information_schema.tables
WHERE table_schema = DATABASE() AND table_name = 'orders';
```

information_schema.tablesμ—μ„ μΈλ±μ¤ Fragmentation νΌμ„Όν‹°μ§€λ¥Ό ν™•μΈν• λ• μ‚¬μ©ν•λ” κ° μ»¬λΌλ“¤μ€ λ‹¤μκ³Ό κ°™λ‹¤.
- data_length: ν…μ΄λΈ”μ μ‹¤μ  λ°μ΄ν„°κ°€ μ°¨μ§€ν•λ” λ°”μ΄νΈ μ, μ¦‰ ν…μ΄λΈ”μ— μ €μ¥λ λ¨λ“  ν–‰(row)μ λ°μ΄ν„° ν¬κΈ°
- index_length: ν…μ΄λΈ”μ μΈλ±μ¤κ°€ μ°¨μ§€ν•λ” λ°”μ΄νΈ μ
- data_free: ν• λ‹Ήλμ—μ§€λ§ μ‚¬μ©λμ§€ μ•λ” λ°”μ΄νΈ μ, μ‚­μ  λλ” μ—…λ°μ΄νΈλ΅ μΈν•΄ μƒκΈ΄ λΉ κ³µκ°„

μ¦‰, λ¶„μ(data_free)λ” λ‚­λΉ„λκ³  μλ” κ³µκ°„μ ν¬κΈ°λ¥Ό λ‚νƒ€λ‚΄κ³  λ¶„λ¨(data_length + index_length + data_free)λ” ν…μ΄λΈ”μ΄ μ‹¤μ λ΅ μ‚¬μ©ν•κ³  μλ” μ „μ²΄ λ¬Όλ¦¬μ μΈ κ³µκ°„μ„ λ‚νƒ€λ‚΄κ² λλ‹¤.

κ°„λ‹¨ν•κ², data_free κ°’μ΄ ν¬λ©΄ μ΅°κ°ν™”κ°€ λ§μ΄ λ°μƒν• μƒνƒλΌκ³ λ„ λ³Ό μ μλ‹¤.

## 1-2. μΈλ±μ¤ μ΅°κ°ν™” ν™•μΈ μ‹¤μµ
μ•„λ μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•μ—¬ orders ν…μ΄λΈ”μ„ μƒμ„±ν›„ 20000κ°μ λ°μ΄ν„°λ¥Ό ν”„λ΅μ‹μ Έλ¥Ό ν†µν•΄ μ‚½μ…ν•΄λ³΄μ.

```sql
CREATE TABLE orders
(
    id             INT AUTO_INCREMENT PRIMARY KEY,
    user_id        INT            NOT NULL,
    user_name      VARCHAR(200)   NOT NULL,
    product_id     INT            NOT NULL,
    order_date     DATE           NOT NULL,
    order_status   ENUM ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    amount         DECIMAL(10, 2) NOT NULL,
    payment_method VARCHAR(20)    NOT NULL,
    created_at     TIMESTAMP                                                          DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP                                                          DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

DROP PROCEDURE IF EXISTS InsertOrders;

DELIMITER $$

CREATE PROCEDURE InsertOrders()
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE random_user_id INT;
    DECLARE random_user_name VARCHAR(200);
    DECLARE random_product_id INT;
    DECLARE random_order_date DATE;
    DECLARE random_order_status ENUM('pending', 'confirmed', 'shipped', 'delivered', 'cancelled');
    DECLARE random_amount DECIMAL(10, 2);
    DECLARE random_payment_method VARCHAR(20);
    DECLARE status_rand INT;
    DECLARE payment_rand INT;

    WHILE i <= 20000 DO
            -- λλ¤ κ°’ μƒμ„±
            SET random_user_id = FLOOR(1 + RAND() * 1000);  -- 1~1000 μ‚¬μ΄ user_id
            SET random_user_name = concat('Name', random_user_id);
            SET random_product_id = FLOOR(1 + RAND() * 500); -- 1~500 μ‚¬μ΄ product_id
            SET random_order_date = DATE_SUB(CURDATE(), INTERVAL FLOOR(RAND() * 365) DAY); -- μµκ·Ό 1λ…„ μ΄λ‚΄
            SET random_amount = ROUND(10 + RAND() * 990, 2); -- 10.00 ~ 1000.00 μ‚¬μ΄ κΈμ•΅

            -- μ£Όλ¬Έ μƒνƒ λλ¤ μ„ νƒ
            SET status_rand = FLOOR(1 + RAND() * 5);
            CASE status_rand
                WHEN 1 THEN SET random_order_status = 'pending';
                WHEN 2 THEN SET random_order_status = 'confirmed';
                WHEN 3 THEN SET random_order_status = 'shipped';
                WHEN 4 THEN SET random_order_status = 'delivered';
                WHEN 5 THEN SET random_order_status = 'cancelled';
                END CASE;

            -- κ²°μ  λ°©λ²• λλ¤ μ„ νƒ
            SET payment_rand = FLOOR(1 + RAND() * 4);
            CASE payment_rand
                WHEN 1 THEN SET random_payment_method = 'credit_card';
                WHEN 2 THEN SET random_payment_method = 'debit_card';
                WHEN 3 THEN SET random_payment_method = 'paypal';
                WHEN 4 THEN SET random_payment_method = 'bank_transfer';
                END CASE;

            -- λ°μ΄ν„° μ‚½μ…
            INSERT INTO orders (user_id, user_name, product_id, order_date, order_status, amount, payment_method)
            VALUES (random_user_id, random_user_name, random_product_id, random_order_date, random_order_status, random_amount, random_payment_method);

            SET i = i + 1;
        END WHILE;
END$$

DELIMITER ;

CALL InsertOrders();
```

μΈλ±μ¤ μ΅°κ°ν™” νΌμ„Όν‹°μ§€λ¥Ό ν™•μΈν•΄λ³΄λ©΄ 72% μ΅°κ°ν™” ν„μƒμ΄ λ°μƒν• κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

![Image](/assets/img/posts/Backend/Database/μΈλ±μ¤μ΅°κ°ν™”_μµμ ν™”μ „_μ΅°κ°ν™”_ν™•μΈ_μ¤ν¬λ¦°μƒ·.png)

## 1-3. μΈλ±μ¤ μ΅°κ°ν™”(Fragmentation) ν•΄κ²° λ°©λ²•
μ΅°κ°ν™”κ°€ μ‹¬ν• κ²½μ° OPTIMIZE TABLE(ν…μ΄λΈ” μµμ ν™”) λλ” ANALYZE TABLE(μΈλ±μ¤ λ¶„μ„)μ„ μ‹¤ν–‰ν•μ—¬ ν•΄κ²°ν•  μ μλ‹¤.

λ‘ SQL λ…λ Ήμ–΄μ™€ κ΄€λ ¨λ λ” μƒμ„Έν• λ‚΄μ©μ€ μ•„λ ν¬μ¤ν…μ— μ μ •λ¦¬λμ–΄ μλ‹¤π€
- OPTIMIZE TABLE: [https://monkeybusiness.tistory.com/806](https://monkeybusiness.tistory.com/806)
- ANALYZE TABLE: [https://monkeybusiness.tistory.com/804](https://monkeybusiness.tistory.com/804)

### ν…μ΄λΈ” μµμ ν™”(OPTIMIZE TABLE)
MySQLμ—μ„λ” OPTIMIZE TABLE λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄ μ΅°κ°ν™”λ¥Ό μ κ±°ν•κ³  κ³µκ°„μ„ μ¬μ‚¬μ©ν•  μ μλ‹¤.

```sql
OPTIMIZE TABLE Customer;
```

## μΈλ±μ¤ λ¶„μ„(ANALYZE TABLE)
MySQLμ—μ„λ” ANALYZE TABLE λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄ μΈλ±μ¤λ¥Ό λ‹¤μ‹ μ •λ¦¬ν•κ³ , ν†µκ³„λ¥Ό μµμ‹  μƒνƒλ΅ μ—…λ°μ΄νΈν•  μ μλ‹¤.

```sql
ANALYZE TABLE Customer;
```

μΈλ±μ¤λ¥Ό λ¶„μ„ν›„ μ •λ¦¬ λ° ν†µκ³„ μ •λ³΄λ¥Ό κ°±μ‹ ν•μ—¬ MySQL μµν‹°λ§μ΄μ €κ°€ μΏΌλ¦¬ μµμ ν™”λ¥Ό ν•λ”λ° λ°μμ‹ν‚¬ μ μλ‹¤.

## 1-4. μΈλ±μ¤ μ΅°κ°ν™” μ¬ν™•μΈ
μΈλ±μ¤ νμ΄μ§€ μµμ ν™”ν›„ λ‹¤μ‹ μΈλ±μ¤ Fragmentation νΌμ„Όν‹°μ§€λ¥Ό ν™•μΈν•΄λ³΄λ©΄ 44% λ΅ μ¤„μ–΄λ“  κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

![Image](/assets/img/posts/Backend/Database/μΈλ±μ¤μ΅°κ°ν™”_μµμ ν™”ν›„_μ΅°κ°ν™”_ν™•μΈ_μ¤ν¬λ¦°μƒ·1.png)

![Image](/assets/img/posts/Backend/Database/μΈλ±μ¤μ΅°κ°ν™”_μµμ ν™”ν›„_μ΅°κ°ν™”_ν™•μΈ_μ¤ν¬λ¦°μƒ·2.png)

Fragmentation νΌμ„Όν‹°μ§€λΏλ§ μ•„λ‹λΌ `data_free` κ°’μ΄ μ¤„μ–΄λ“¤μ—λ‹¤λ©΄ μ΅°κ°ν™”κ°€ ν•΄κ²°λ κ²ƒμΌλ΅ λ³Ό μ μλ‹¤.

## 1-5. μ •λ¦¬
- MySQLμ—μ„ INSERT, UPDATE, DELETE μ‘μ—…μ΄ λ°λ³µλλ©΄ μΈλ±μ¤ μ΅°κ°ν™”κ°€ λ°μƒν•¨
- μ΅°κ°ν™”κ°€ μ‹¬ν•΄μ§€λ©΄ μΏΌλ¦¬ μ„±λ¥μ΄ μ €ν•λ¨
- μ΅°κ°ν™” ν™•μΈμ€ SHOW TABLE STATUS λλ” information_schema.tablesμ„ μ‚¬μ©ν•μ—¬ μν–‰ν•¨
- μ΅°κ°ν™”κ°€ μ‹¬ν•λ©΄ OPTIMIZE TABLEμ„ μ‹¤ν–‰ν•μ—¬ ν…μ΄λΈ”μ„ μµμ ν™”ν•΄μ•Ό ν•¨
- μΈλ±μ¤ ν†µκ³„λ¥Ό μµμ‹  μƒνƒλ΅ μ μ§€ν•λ ¤λ©΄ ANALYZE TABLEμ„ μ‹¤ν–‰ν•΄μ•Ό ν•¨

MySQLμ—μ„ μΈλ±μ¤ μ μ§€λ³΄μλ¥Ό μ •κΈ°μ μΌλ΅ μν–‰ν•λ©΄ λ°μ΄ν„°λ² μ΄μ¤ μ„±λ¥μ„ μµμ ν™”ν•  μ μλ‹¤.

μ°Έκ³ : [https://dev.mysql.com/doc/refman/8.4/en/sorted-index-builds.html](https://dev.mysql.com/doc/refman/8.4/en/sorted-index-builds.html)

# 2. Fill Factorλ€?



### Reference
- [https://osumaniaddict527.tistory.com/42#1.%20μΈλ±μ¤%20μ΅°κ°ν™”(Fragmentation)λ€%3F-1](https://osumaniaddict527.tistory.com/42#1.%20μΈλ±μ¤%20μ΅°κ°ν™”(Fragmentation)λ€%3F-1)
- [https://monkeybusiness.tistory.com/804](https://monkeybusiness.tistory.com/804)