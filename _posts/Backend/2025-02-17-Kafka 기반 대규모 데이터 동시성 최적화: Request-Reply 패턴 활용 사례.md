---
title: "Kafka 기반 대규모 데이터 동시성 최적화: Request-Reply 패턴 활용 사례"
date: 2025-02-17 +0800
categories: [Backend]
tags: [woowacon24]
toc: true
comments: true
published: false
---

> 우아콘24의 ['Kafka 기반 대규모 데이터 동시성 최적화: Request-Reply 패턴 활용 사례'](https://www.youtube.com/watch?v=Rcow99TIMmc&list=PLgXGHBqgT2Tu7H-ita_W0IHospr64ON_a&index=5)' 에 대한 학습 내용을 정리하기 위한 목적의 TIL 포스팅입니다.🙆‍♂️

# 도입 배경
- 주문이 급증하는 지역에 소수의 라이더가 존재한다고 가정했을때 고객들의 배송이 지연되는 현상이 발생하게 됨
- 이때 시스템에선 '주문수 대비 라이더가 너무 부족해!' 라는 경고를 띄우게 됨
- 이 경고를 해결하고자 '주문 유입량 조절'이라는 기능을 사용함
  - 주문량을 줄이기 위해 주문 배달 반경을 일시적으로 축소하는 것
- '주문 유입량 조절' 동시 발생 가능한 N개의 트리거가 존재함
  - 1)주문수 대비 라이더 부족
  - 2)기상 악화
  - 3)장애 상황 감지
- 주문 유입량을 조절해야 하는 대상은 가게수 수십만개 이상
- N개의 트리거로 수십만개의 가게가 동시에 변경되면?
  - "동시에 변경되면?" => 여러 프로세스가 디비의 같은 컬럼을 동시에 변경하게 되면?
  - 트리거 1, 2, 3 이 동시에 실행되서 같은 컬럼을 수정하게 되면 "Deadlock found when trying to get lock, Lock wait timout exceeded" 에러를 마주하게 됨
  - 이때 DB를 활용한 낙관락 or 비관락, Redis를 활용한 분산락을 활용하여 해결할 수 있음
- 하지만 트리거의 순서를 보장하여 실행되어야함
  - '주문수 대비 라이더 부족' 트리거와 '장애 상황 감지' 트리거가 동시에 실행되면 순차적으로 실행되어야함
- 단순 락을 걸면 정확한 순서 보장이 가능하지 않다.