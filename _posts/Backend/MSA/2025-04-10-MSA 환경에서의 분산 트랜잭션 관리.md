---
title: "MSA 환경에서의 분산 트랜잭션 관리"
date: 2025-04-10 +0800
categories: [Backend, MSA]
tags: [msa, 2pc, saga]
toc: true
comments: true
published: false
---

MSA 환경에서 고민해야되는 포인트는 도메인별로 분산된 DB를 가질때의 트랜잭션 관리다.

단일 DB에서 제공하는 트랜잭션을 활용할 수 없다보니 전체적인 데이터 일관성과 무결성을 보장하기 위한 고민이 필요하다.

이를 해결하기 위한 대표적인 방식인 2PC 프로토콜(2Phase Commit)과 Saga Pattern에 대해 알아보자.

# 2PC(2Phase Commit) 프로토콜
MSA 가 대중화 되기 이전에 분산 데이터베이스 환경에서 데이터 일관성을 만족시키기 위해 널리 사용되었던 프로토콜 중 하나다.

![Image](./MSA환경에서의분산트랜잭션관리_2PC_구조.png)

전체적인 흐름은 중간의 Coorinator가 2단계(준비, 커밋)로 나뉘어 두 노드(DBMS)에 커밋을 진행하는 방식이다.

**1) 준비 단계(prepare phase)**

![Image](./MSA환경에서의분산트랜잭션관리_2PC_준비단계.png)

첫 번째, 준비 단계에서는 Coorinator가 모든 노드(DBMS)에 트랜잭션 열어 Lock을 획득후 커밋 가능 여부를 응답한다.

**2) 커밋 단계(commit phase)**

![Image](./MSA환경에서의분산트랜잭션관리_2PC_커밋단계.png)

두 번째, 커밋 단계에서는 모든 노드가 준비 완료될 경우 commit 요청을 전송하고, 만약 하나라도 준비 실패한다면 rollback 요청을 보냄으로써 두 노드간의 데이터 일관성을 보장한다.

## 2PC 단점
**MSA 환경에서는 다음과 같은 단점들로 거의 사용되지 않는다.**

- 모든 요청을 처리할 때까지 관련된 모든 DB에 Lock이 설정된다. 따라서, 지연 시간(Latency)가 증가할 수 있다.
  - 만약 비즈니스가 복잡해져서 관련 DB가 늘어난다면 그에 비례해서 지연 시간이 길어질 수 있다.
- 서비스 간 강결합을 초래한다.
    - MSA 구조를 도입하는 이유는 각 서비스 간의 결합을 줄이고 독립적인 서비스를 구축하기 위함이다.
    - 하지만 2PC를 적용하면 Coodinator를 기반으로 서비스 간의 강력한 결합이 생기기 때문에 MSA 구조를 사용하는 의미가 퇴색될 수 있다.
    - 만약 코디네이터에 장애가 발생하면...? 전체 트랜잭션이 불확실한 상태에 빠질 수 있다. 코디네이터가 복구될 때까지 참여자들은 Lock을 획득하고 있으므로 대기 상태가 된다.
- 제약사항이 존재한다.
  - 사용하는 DBMS가 분산 트랜잭션을 지원해야 사용할 수 있으며, 같은 종류의 DBMS여야 한다.
  - NoSQL 은 지원 X
- 모든 노드가 커밋 혹은 롤백을 완료할 때까지 기다려야 하기 때문에, 네트워크 지연이나 참여자 지연이 있을 경우 성능 저하로 이어질 수 있다.

# Saga Pattern
**MSA 환경에서 흔히 자주 사용되는 보상 트랜잭션 기법이다.**



## Choreography Saga 패턴

## Orchestration Saga 패턴

# Reference
- [https://bezzang2.tistory.com/233](https://bezzang2.tistory.com/233)
- [https://kadensungbincho.tistory.com/125](https://kadensungbincho.tistory.com/125)
- [https://baebalja.tistory.com/622](https://baebalja.tistory.com/622)
- [https://www.youtube.com/watch?v=xpwRTu47fqY](https://www.youtube.com/watch?v=xpwRTu47fqY)
- [https://devk0ng.github.io/2021/07/27/saga_pattern/#2-Phase-Commit](https://devk0ng.github.io/2021/07/27/saga_pattern/#2-Phase-Commit)
- [https://ksh-coding.tistory.com/143](https://ksh-coding.tistory.com/143)
- [https://velog.io/@ch200203/MSA-환경에서의-분산-트랜잭션-관리2PC-SAGA-패턴](https://velog.io/@ch200203/MSA-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%EB%B6%84%EC%82%B0-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B4%80%EB%A6%AC2PC-SAGA-%ED%8C%A8%ED%84%B4)
- [https://velog.io/@hgs-study/saga-1](https://velog.io/@hgs-study/saga-1)
- [https://velog.io/@ouk/2단계-커밋-프로토콜2PC이란-무엇이며-어떻게-동작하나요](https://velog.io/@ouk/2%EB%8B%A8%EA%B3%84-%EC%BB%A4%EB%B0%8B-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C2PC%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%B4%EB%A9%B0-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8F%99%EC%9E%91%ED%95%98%EB%82%98%EC%9A%94)
- [https://haon.blog/article/toss-slash/distribution-transaction](https://haon.blog/article/toss-slash/distribution-transaction)