---
title: "[클린코드] Chapter13-동시성"
date: 2024-07-11 +0800
categories: [책, 클린코드]
tags: [cleancode]
toc: true
comments: true
# image: /assets/img/test.png
# pin: true
---

### 동시성이 필요한 이유?
- 동시성은 결합(coupling)을 없애는 전략이다. 즉, 무엇(what)과 언제(when)을 분리하는 전략이다.
- 무엇과 언제를 분리하면 애플리케이션 구조와 효율이 극적으로 나아진다.
- 예를 들어, 서블릿은 웹 요청이 들어올때마다 웹서버는 비동기식으로 서블릿을 실행한다.
  - 서블릿 프로그래머는 들어오는 모든 웹 요청을 관리할 필요가 없다.
  - 원칙적으로 각 서블릿 스레드는 다른 서블릿 스레드와 무관하게 자신만의 세상에서 돌아간다.
- 어떤 시스템은 응답 시간과 작업 처리량 개선이라는 요구사항으로 인해 직접적인 동시성 구현이 불가피하다.
  - 예를 들어, 매일 수 많은 웹 사이트에서 정보를 가져와 요약하는 정보 수집기(information aggregator), 정보를 대량으로 분석하는 시스템

### 미신과 오해

#### 동시성과 관련한 일반적인 미신과 오해
- **동시성은 항상 성능을 높여준다.**
  - 때로는 성능을 높여준다. 여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능이 높아진다.
- **동시성을 구현해도 설계는 변하지 않는다.**
  - 단일 스레드 시스템과 다중 스레드 시스템은 설계가 판이하게 다르다. 일반적으로 무엇과 언제를 분리하면 시스템 구조가 크게 달라진다.
- **웹 또는 EJB컨테이너를 사용하면 동시성을 이해할 필요가 없다.**
  - 실제로는 컨테이너가 어떻게 동작하는지, 어떻게 동시 수정, 데드락 등과 같은 문제를 피할 수 있는지를 알아야 한다.
  
#### 동시성과 관련된 타당한 생각
- **동시성은 다소 부하를 유발한다.** 성능 측면에서 부하가 걸리며, 코드도 더 짜야한다.
- **동시성은 복잡하다.**
- **일반적으로 동시성 버그는 재현하기 어렵다.**
- **동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.**

### 동시성 방어 원칙
- 동시성 코드가 일으키는 문제로부터 시스템을 방어하는 원칙과 기술을 소개한다.

#### 단일 책임 원칙 (Single Responsibility Principle, SRP)
- 주어진 메서드/클래스/컴포넌트를 변경할 이유가 하나여야 한다는 원칙이다.
- 동시성은 복잡성 하나만으로도 분리할 이유가 충분하다.
- **권장사항: 동시성 관련 코드는 다른 코드와 분리해야 한다.**

#### 따름 정리(corollary): 자료 범위를 제한하라
- 공유 객체를 가용하는 코드 내 **임계영역(critical section)**을 **synchronized** 키워드로 보호하라고 권장한다.
- 이런 임계영역의 수를 줄이는 기술이 중요하다. 공유 자료를 수정하는 위치가 많을수록 다음 가능성도 커진다.
  - 보호할 임계영역을 빼먹는다. 그래서 공유 자료를 수정하는 모든 코드를 망가뜨린다.
  - 모든 임계영역을 올바로 보호했는지 확인하느라 똑같은 노력과 수고를 반복한다.
  - 그렇지 않아도 찾아내기 어려운 버그가 더욱 찾기 어려워진다.
- **권장사항: 자료를 캡슐화하라. 공유 자료를 최대한 줄여라.**
 
#### 따름 정리(corollary): 자료 사본을 사용하라
- 공유 자료를 줄이려면 처음부터 공유하지 않는 방법이 제일 좋다.
- 어떤 경우에는 객체를 복사해 읽기 전용으로 사용하는 방법이 가능하며, 어떤 경우에는 각 스레드가 객체를 복사해 사용후 한 스레드가 해당 사본에서 결과를 가져오는 방법도 가능하다.

#### 따름 정리(corollary): 스레드는 가능한 독립적으로 구현하라
- 자신만의 세상에 존재하는 스레드를 구현하라. 즉, 다른 스레드와 자료를 공유하지 않도록 말이다.
- 예를 들어, HttpServlet 클래스에서 파생한 클래스는 모든 정보를 doGet 과 doPost 매개변수로 받는다. 그래서 각 서블릿은 마치 자신이 독자적인 시스템에서 동작하는 양 요청을 처리한다. 서블릿 코드가 로컬 변수만 사용한다면 서블릿이 동기화 문제를 일으킬 가능성은 전무하다. 물론 서블릿을 사용하는 대다수 애플리케이션은 결국 DB 커넥션과 같은 자원을 공유하는 상황에 처한다.
- 권장사항: 독자적인 스레드로, 가능하면 다른 프로세서에서 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라.





#### Reference
- 예제 코드 및 이미지 출처
  - [https://haeng-on.tistory.com/74](https://haeng-on.tistory.com/74)
  - [https://hirlawldo.tistory.com/147](https://hirlawldo.tistory.com/147)
