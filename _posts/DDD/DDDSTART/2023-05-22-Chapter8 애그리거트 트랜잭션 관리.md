---
title: "[DDDSTART] Chapter8-애그리거트 트랜잭션 관리" # post의 layout이 기본적으로 post로 설정되어있어서 Front Matter에 따로 layout변수를 만들어 주지 않아도 됨
date: 2023-05-22 15:10:00 +0800
categories: [DDD, DDDSTART] # categories는 최대 2개까지 가능
tags: [ddd, dddstart] # TAG는 반드시 소문자로 이루어져야함, 0~무한개까지 지정 가능
toc: true # Table Of Content(TOC) 옵션, 기본적으로 포스트의 오른쪽 패널에 위치
comments: true # 댓글 유무 지정
# image: /assets/img/test.png # Preview image
# pin: true # 홈페이지 메인화면에 특정 게시물 고정
---


### 애그리거트와 트랜잭션

- 한 주문 애그리거트에 대해 운영자는 배송 상태로 변경할 때 사용자는 배송지 주소를 변경하면 어떻게 될까?
- 아래 이미지는 발생할 수 있는 다양한 경우 중 한 가지를 시간 순서로 표시한 것이다.

![image](https://github.com/jeonyoungho/jeonyoungho.github.io/assets/44339530/675abb4a-95fe-481e-ac2a-c5c320c35c5b)

- 운영자 스레드와 고객 스레드는 개념적으로 동일한 애그리거트지만 물리적으로 서로 다른 애그리거트 객체를 사용한다.
- 때문에 운영자 스레드가 주문 애그리거트 객체를 배송 상태로 변경하더라도 고객 스레드가 사용하는 주문 애그리거트 객체엔 영향을 주지 않는다.
- 고객 스레드 입장에서 주문 애그리거트 객체는 아직 배송 상태 전이므로 배송지 정보를 변경 가능하다.
- 그렇기 때문에 애그리거트의 일관성이 깨지게 되는 것이다.
- 이런 문제가 발생하지 않도록 하려면 다음의 두 가지 중 하나를 해야 한다.
  - <b>1)운영자가 배송지 정보를 조회하고 상태를 변경하는 동안 고객이 애그리거트를 수정하지 못하게 막는다.</b>
  - <b>2)운영자가 배송지 정보를 조회한 이후에 고객이 정보를 변경하면 운영자가 애그리거트를 다시 조회한 뒤 수정하도록 한다.</b>
- 위 두 가지는 애그리거트 자체의 트랜잭션과 관련이 있다.
- DBMS가 지원하는 트랜잭션과 함께 애그리거트를 위한 추가적인 트랜잭션 처리 기법이 필요하다.
- 애그리거트에 대해 사용할 수 있는 대표적인 트랜잭션 처리 방식에는 선점(Pessimistic) 잠금과 비선점(Optimistic) 자금의 두 가지 방식이 있는데 이어서 살펴보자.

> **Note**: Pessimistic Lock 과 Optimistic Lock을 비관적 잠금과 낙관적 잠금이라 많이 표현하는데 의미가 조금 더 가까운 선점 잠금과 비선점 잠금이란 용어를 저자는 사용하였다.

### 선점 잠금(Pessimistic Lock)
- 선점 잠금은 애그리거트를 먼저 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하는 것을 막는 방식이다.

![image](https://github.com/jeonyoungho/jeonyoungho.github.io/assets/44339530/76f05cfb-8a63-4183-b88e-979bf4c78ae1)

- 스레드1이 선점 잠금 방식으로 애그리거트를 구한 후 스레드2는 스레드1인 애그리거트에 대한 잠금을 해제할 때 까지 블로킹된다.
- 이러한 선점 잠금을 사용하면, 한 스레드가 애그리거트를 구하고 수정하는 동안 다른 스레드가 수정할 수 없으므로 동시에 애그리거트를 수정할 때 발생하는 데이터 충돌 문제를 해소할 수 있다.
  - 앞서 배송지 정보 수정과 배송 상태 변경을 동시에 하는 문제에 선점 잠금을 적용하면 아래 이미지와 같이 동작한다.

![image](https://github.com/jeonyoungho/jeonyoungho.github.io/assets/44339530/c57ad2f2-4e5d-4605-afa3-0338978db852)

- 운영자 스레드가 먼저 선점 잠금 방식으로 주문 애그리거트를 구한 경우 운영자 스레드가 잠금을 해제할 때까지 고객 스레드는 대기 상태가 된다.
- 운영자 스레드가 배송 상태로 변경한 뒤 트랜잭션을 커밋하면 잠금을 해제한다.
- 잠금이 해제된 시점에 고객스레드가 구하는 주문 애그리거트는 운영자 스레드가 수정한 배송 상태의 주문 애그리거트이다.
- 배송 상태이므로 배송지 변경시 에러를 발생하고 트랜잭션은 실패하게 된다.
- 이 시점에 고객은 '이미 배송이 시작되어 배송지를 변경할 수 없습니다' 와 같은 안내 문구를 보게 될 것이다.
- <b>선점 잠금은 보통 DBMS가 제공하는 행 단위 잠금을 사용해서 구현한다.</b>
- <b>오라클을 비롯한 다수 DBMS가 for update 와 같은 쿼리를 사용해서 특정 레코드에 한 사용자만 접근할 수 있는 잠금 장치를 제공한다.</b>
- JPA의 EntityManager 는 LockModeType 을 인자로 받는 find() 메서드를 제공하는데, LockModeType.PESSIMISTIC_WRITE를 값으로 전달하면 해당 엔티티와 매핑된 테이블을 이용해서 선점 잠금 방식을 적용할 수 있다.

```java
Order order = entityManager.find(Order.class, orderNo, LockModeType.PESSIMISTIC_WRITE;
```

- JPA 프로바이더와 DBMS에 따라 잠금 모드의 구현이 다른데, 하이버네이트의 경우 `PESSIMISTIC_WRITE`를 잠금 모드로 사용하면 `for update` 쿼리를 사용해서 선점 잠금을 구현한다.


### 선점 잠금과 교착 상태
- 선점 잠금 기능을 사용할 땐 잠금 순서에 따른 교착 상태(deadlock)가 발생하지 않도록 주의해야 한다.
- 예를 들어, 다음과 같은 수서로 두 스레드가 잠금 시도를 한다 해보자.

```text
1. 스레드1: A 애그리거트에 대한 선점 잠금 구함
2. 스레드2: B 애그리거트에 대한 선점 잠금 구함
3. 스레드1: B 애그리거트에 대한 선점 잠금 시도
4. 스레드2: A 애그리거트에 대한 선점 잠금 시도
```



### Reference
- 예제 코드 및 이미지
  - [https://heeveloper.github.io/2020/08/29/08-%EC%95%A0%EA%B7%B8%EB%A6%AC%EA%B1%B0%ED%8A%B8-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B4%80%EB%A6%AC/](https://heeveloper.github.io/2020/08/29/08-%EC%95%A0%EA%B7%B8%EB%A6%AC%EA%B1%B0%ED%8A%B8-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EA%B4%80%EB%A6%AC/)
  - [https://velog.io/@hoonki/%EB%A9%80%ED%8B%B0-%EC%8A%A4%EB%A0%88%EB%93%9C-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%EC%84%A0%EC%A0%90-%EC%A0%90%EA%B8%88-%EB%B9%84%EC%84%A0%EC%A0%90-%EC%9E%A0%EA%B8%88-%EC%98%A4%ED%94%84%EB%9D%BC%EC%9D%B8-%EC%84%A0%EC%A0%90-%EC%9E%A0%EA%B8%88](https://velog.io/@hoonki/%EB%A9%80%ED%8B%B0-%EC%8A%A4%EB%A0%88%EB%93%9C-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0%EC%84%A0%EC%A0%90-%EC%A0%90%EA%B8%88-%EB%B9%84%EC%84%A0%EC%A0%90-%EC%9E%A0%EA%B8%88-%EC%98%A4%ED%94%84%EB%9D%BC%EC%9D%B8-%EC%84%A0%EC%A0%90-%EC%9E%A0%EA%B8%88)