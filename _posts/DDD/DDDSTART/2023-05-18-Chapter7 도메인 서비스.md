---
title: "[DDDSTART] Chapter7-도메인 서비스" # post의 layout이 기본적으로 post로 설정되어있어서 Front Matter에 따로 layout변수를 만들어 주지 않아도 됨
date: 2023-05-18 15:10:00 +0800
categories: [DDD, DDDSTART] # categories는 최대 2개까지 가능
tags: [ddd, dddstart] # TAG는 반드시 소문자로 이루어져야함, 0~무한개까지 지정 가능
toc: true # Table Of Content(TOC) 옵션, 기본적으로 포스트의 오른쪽 패널에 위치
comments: true # 댓글 유무 지정
# image: /assets/img/test.png # Preview image
# pin: true # 홈페이지 메인화면에 특정 게시물 고정
---

### 여러 애그리거트가 필요한 기능(도메인 서비스가 필요한 이유)
- 도메인 영여그이 코드를 작성하다보면 한 애그리거트로 기능을 구현할 수 없을 때가 있다.
  - 대표적인 예가, 결제 금액 계산 로직인데 아래와 같은 사항들을 고려볼 수 있다.
  - `상품 애그리거트` : 구매하는 상품의 가격. 또는 상품에 따라 추가되는 배송비
  - `주문 애그리거트` : 상품별 구매 개수
  - `할인 쿠폰 애그리거트` : 쿠폰별 지정된 할인 금액, 비율과 중복 사용 여부 등의 조건
  - `회원 애그리거트` : 회원 등급에 따른 추가 할인
- 이런 경우 실제 결제 금액을 계산해야 하는 주체는 어떤 애그리거트일까? 
- 총 주문 금액을 계산하는 것은 주문 애그리거트가 할 수 있지만 실제 결제 금액은 이야기가 다르다. 총 주문 금액에서 할인 금액을 계산해야 한다. 
- 그렇다고 할인 쿠폰 규칙을 갖고 있는 할인 쿠폰 애그리거트에서 계산한다면 할인 쿠폰을 두 개 이상 적용할 때 단일 할인 쿠폰 애그리거트로는 총 결제 금액을 계산할 수 없다.
- 생각해 볼 수 있는 방법은 주문 애그리거트가 필요한 애그리거트나 필요 데이터를 모두 가지도록 한 뒤 할인 금액 계산 책임을 주문 애그리거트에 할당하는 것이다.

```java
public class Order {
  ...
  private Orderer orderer;
  private List<OrderLine> orderLines;
  private List<Coupon> usedCoupons;
  
  private Money calculatePayAmounts() {
    // 총 지불 금액 계산 로직
    ...
  }
  
  private Money calculateDiscount(Coupon coupon) {
    // 쿠폰에 따른 할인 금액 계산 로직
    ...
  }

  private Money calculateDiscount(MemberGrade grade) {
    // 회원 등급에 따른 할인 금액 계산 로직
    ...
  }
}
```

- <b>여기서 고민거리는 결제 금액 계산 로직이 주문 애그리거트의 책임이 맞느냐에 대한 것이다.</b>
- 예를 들어, 특별 감사 세일로 전 품목에 한 달간 5% 추가 할인을 하기로 했을 때, 이 할인 정책은 주문 애그리거트의 구성요소와는 관련이 없음에도 불구하고 결제 금액 계산 책임이 주문 애그리거트에 있다는 이유로 주문 애그리거트 코드를 수정해야 한다.
- 이렇게 한 애그리거트에 넣기 애매한 도메인 기능을 특정 애그리거트에서 억지로 구현하면 안된다.
- <b>이 경우 애그리거트는 자신의 책임 범위를 넘어서는 기능을 구현하기 때문에 코드가 길어지고 외부에 대한 의존이 높아지게 된다.</b>
  - <b>이는 코드를 복잡하게 만들어 수정을 어렵게 만드는 요인이 되며 게다가 애그리거트의 범위를 넘어서는 도메인 개념이 애그리거트에 숨어들어서 명시적으로 드러나지 않게 된다.</b>
- 이때 가장 쉬운 해결책이 `도메인 서비스` 를별도로 구현하는 것이다.

### 도메인 서비스
- 응용 서비스가 응용 로직을 다룬다면 도메인 서비스는 도메인 로직을 다룬다.

### Reference
- 예제 코드 및 이미지
  - [https://heeveloper.github.io/2020/08/27/07-%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%84%9C%EB%B9%84%EC%8A%A4/](https://heeveloper.github.io/2020/08/27/07-%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%84%9C%EB%B9%84%EC%8A%A4/)